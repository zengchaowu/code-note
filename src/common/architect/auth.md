鉴权（Authentication）是指在计算机系统中，验证用户身份的过程，确保用户拥有所请求的资源的合法权限。

## 鉴权的方式

1. 数字证书鉴权，数字证书由机构颁发，包含一些基本信息和公钥。
2. OAuth鉴权。OAuth是一种授权协议，它允许用户授权第三方应用程序访问他们的资源，而无需将用户名和密码共享给第三方应用程序。
3. API密钥认证。在请求头中提供API密钥作为凭证，服务器通过验证密钥来确定用户是否有权访问资源。
4. token认证。在请求头中提供Token作为凭证。服务器通过验证Token来确定用户是否有权访问资源。


## OAuth2.0

OAuth2.0协议的主要参与方包括资源拥有者（Resource Owner）、客户端（Client）和授权服务器（Authorization Server）。资源拥有者是指资源的拥有者或代理，客户端是指需要访问资源的第三方应用程序，授权服务器是指负责对资源进行授权的服务器。

常用的OAuth 2.0授权访问方式包括授权码模式（Authorization Code Grant）和隐式授权模式（Implicit Grant）。它们的使用场景不同：

### 授权码模式

适用于客户端在服务器上运行的应用程序，客户端可以保持客户端ID和客户端密钥的机密性。它可以将访问令牌保存在服务器端，客户端可以在后续的请求中使用它。流程如下：

1. 客户端携带（客户端id，请求范围，重定向URI）向授权服务器发起请求。
2. 授权服务器向用户展示客户端信息和请求范围
3. 用户同意，授权服务器生成一个授权码，通过附加在重定向URI中作为参数返回给客户端。
4. 客户端携带（授权码，客户端id，客户端密钥，重定向URI）向授权服务器请求访问令牌。
5. 授权服务器验证通过后，则返回令牌（访问令牌，刷新令牌，令牌类型和有效期）
6. 客户端使用访问令牌向资源服务器请求访问资源。如果访问令牌过期，客户端可以使用刷新令牌获取新的访问令牌。

**为什么使用重定向URI**

这里的重定向URI主要作用是将授权码返回给客户端，之所以不通过http直接返回的原因是，如果直接将它们返回给客户端，容易被黑客窃取。使用重定向URI的方式，可以将授权码作为参数附加在重定向URI中，然后将重定向URI发送到客户端。客户端在收到重定向URI后，可以从中获取授权码，从而完成认证和授权。重定向URI通常是需要在授权服务器上注册的，只有注册过的URI，授权服务器才会发起请求将授权码带回。

第四步中，请求仍然带上重定向URI的作用主要是出于安全考虑。授权服务器会验证这个URI和授权码是否匹配。

**令牌过期处理**

当访问令牌过期后，客户端可以使用刷新令牌来获取新的访问令牌。刷新令牌是在获取访问令牌时一并返回的，具有更长的有效期限，并且只能用于获取新的访问令牌，而不能直接用于访问资源服务器。如果刷新令牌过期了，客户端需要重新进行授权流程，获取新的访问令牌和刷新令牌。

**应用怎么知道是哪个用户授权了呢**

OAuth2.0的鉴权流程中，没有明确说明是对哪个用户的信息进行鉴权。这是因为OAuth2.0的授权机制是基于应用程序而非用户的，它将应用程序作为一个整体进行授权。当用户授权应用程序访问其资源时，授权服务器将颁发访问令牌和刷新令牌，这对令牌与用户是关联的。

### 隐式授权模式

适用于客户端在用户代理（如浏览器）中运行的应用程序。因为客户端ID和密钥将公开在JavaScript中，所以它适用于无法保证客户端机密性的应用程序。与授权码模式相比，省略了获取访问令牌的中间步骤，直接将访问令牌作为 URL 锚点返回给客户端。流程如下：

1. 客户端发起授权请求，向授权服务器传递必要的参数，包括客户端 ID、重定向 URI、授权类型（此处为“token”）和范围等。
2. 用户在授权服务器上进行身份验证，同意授权请求。
3. 授权服务器将访问令牌作为 URL 锚点返回给客户端，客户端从中提取令牌。
4. 客户端使用访问令牌向资源服务器请求受保护的资源。

**令牌泄露问题**

第三步返回的token容易被黑客拦截。除了使用https保证安全性，只能将token有效期设置得比较短。

## 密钥认证

API提供者在调用API之前，向API使用者颁发一个密钥，API使用者在每次请求API时，需要提供该密钥以验证其身份。

API密钥认证的优点是简单易用，适用于大多数API调用场景。缺点是密钥可能被泄露，导致未经授权的访问。为了增强安全性，API提供者通常会采用其他身份验证方式，如OAuth等，来提供更可靠的身份验证和授权机制。

## token认证

Token认证是一种基于令牌的身份验证方式，常用于Web应用程序的身份验证和授权。其基本思想是：当用户通过用户名和密码成功登录后，服务器生成一个令牌（Token），并将该令牌发送给客户端。客户端在每次请求时，需要在请求中包含该令牌，以验证其身份。

OAUTH2.0中的访问令牌和刷新令牌，也是使用到了token认证作为后续对资源服务器的鉴权，并且通常也是一个jwttoken。

### token种类

**jwt**

JWT本质上是一种令牌（Token），由三部分组成：头部（Header）、载荷（Payload）和签名（Signature）。
1. 头部（Header）通常包含有关令牌的元数据，例如令牌类型、算法类型等。
2. 载荷（Payload）是JWT的主体部分，用于传递有关用户和应用程序的信息，例如用户ID、授权范围等。载荷还可以包含自定义的声明。
3. 签名（Signature）是对头部和载荷进行数字签名的结果，用于验证令牌的真实性和完整性。签名使用密钥进行计算，以防止伪造和篡改。

JWT具有可靠性高、安全性好、易于传输等优点，被广泛应用于Web应用程序中的身份验证和授权等方面。由于JWT本身包含有关用户的信息，因此可以避免每次请求都需要进行身份验证的问题，从而提高应用程序的性能和可扩展性。JWT本身是可以被解码（decode）的，因为它是基于Base64编码的。解码后可以看到令牌的头部和载荷部分的内容，但是无法获得签名部分的信息，因为签名是使用密钥进行计算的，只有持有密钥的人才能验证签名的有效性。因此，JWT本身是安全的，只有在使用不当或密钥被泄露的情况下才会出现安全问题。

### Bearer

Bearer是一个身份验证协议，它的作用是在HTTP请求头中携带访问令牌（Access Token）来完成身份验证。Bearer的作用不是用来加密数据，而是用来传递访问令牌信息的。

Bearer协议规定，HTTP请求头中需要包含一个Authorization字段，字段值为Bearer和Access Token的组合，中间用一个空格隔开。

这样，服务端就可以从HTTP请求头中获取Access Token来完成身份验证了。如果不加Bearer前缀，服务端就无法知道Authorization字段中携带的是Access Token还是其他信息，从而无法完成身份验证。

总之，Bearer协议是一种标准的身份验证协议，如果你想使用Access Token来完成身份验证，那么就需要遵循Bearer协议来设置HTTP请求头。


## 鉴权服务架构